<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sketch Licensor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      :root{ --bg:#0b0e14; --fg:#e6f1ff; --card:rgba(255,255,255,.05); --line:rgba(255,255,255,.12); --accent:#9ad1ff; }
      html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
      .wrap{padding:14px}
      .card{background:var(--card);border:1px solid var(--line);border-radius:12px}
      .card-header{border-bottom:1px solid var(--line);background:transparent}
      .pill{padding:2px 6px;border-radius:999px;border:1px solid #243246;background:#0c121b;font-size:12px;margin-right:6px}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="d-flex gap-2 align-items-center mb-3">
        <h1 class="m-0 fs-4">Sketch Licensor</h1>
        <span class="pill ms-auto">Sketch: <%= id %></span>
        <a class="btn btn-sm btn-outline-light" href="/licensor-tools/" target="_blank" rel="noopener">Open Licensor Toolkit</a>
        <a class="btn btn-sm btn-outline-info" href="/?id=<%= id %>">Back to Playground</a>
      </div>

      <div class="card mb-3">
        <div class="card-header">License & Authority</div>
        <div class="card-body row g-3">
          <div class="col-md-3">
            <label class="form-label">Software License</label>
            <select id="licSoftware" class="form-select form-select-sm">
              <option>MIT</option><option>Apache-2.0</option><option>GPL-3.0</option>
              <option>AGPL-3.0</option><option>LGPL-3.0</option><option>MPL-2.0</option>
              <option>BSL-1.1</option><option>EUPL-1.2</option><option>CAL-1.0</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Hardware License</label>
            <select id="licHardware" class="form-select form-select-sm">
              <option>CERN-OHL-P-2.0</option><option>CERN-OHL-W-2.0</option><option>CERN-OHL-S-2.0</option>
              <option>Solderpad-2.1</option><option>TAPR-OHL-1.0</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Data License</label>
            <select id="licData" class="form-select form-select-sm">
              <option>CC-BY-4.0</option><option>CC-BY-SA-4.0</option><option>CC0-1.0</option>
              <option>ODC-By-1.0</option><option>ODbL-1.0</option><option>Open Data Commons PDDL-1.0</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Art/Media License</label>
            <select id="licArt" class="form-select form-select-sm">
              <option>CC-BY-4.0</option><option>CC-BY-SA-4.0</option><option>CC-BY-NC-4.0</option>
              <option>CC-BY-NC-SA-4.0</option><option>CC0-1.0</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Namespace</label>
            <input id="namespace" class="form-control form-control-sm" placeholder="e.g. spectra.gallery/sketches" value="<%- namespace %>">
          </div>
          <div class="col-md-4">
            <label class="form-label">Authority</label>
            <input id="authority" class="form-control form-control-sm" placeholder="e.g. Uniphilabs Cooperative" value="<%- authority %>">
          </div>
          <div class="col-12">
            <label class="form-label">Properties (comma-separated)</label>
            <input id="properties" class="form-control form-control-sm" placeholder="e.g. continuity, safety, autonomy" value="<%- properties %>">
          </div>
          <div class="col-12">
            <button id="saveLicense" class="btn btn-sm btn-primary">Save License Metadata</button>
            <a id="downloadYugen" class="btn btn-sm btn-outline-info" href="/sketch/<%= id %>/download?format=yugen">Download Licensed HTML</a>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Current Metadata</div>
        <div class="card-body">
          <pre class="small" id="curMeta"></pre>
        </div>
      </div>
    </div>
    <script>
      const ID = <%- JSON.stringify(id) %>;
      const initial = <%- JSON.stringify(attrs||{}) %>;
      (function prefill(){
        const lic = (initial.licenses||{});
        if (lic.software) document.getElementById('licSoftware').value = lic.software;
        if (lic.hardware) document.getElementById('licHardware').value = lic.hardware;
        if (lic.data) document.getElementById('licData').value = lic.data;
        if (lic.art) document.getElementById('licArt').value = lic.art;
      })();
      document.getElementById('curMeta').textContent = JSON.stringify(initial, null, 2);
      document.getElementById('saveLicense').onclick = async function(){
        const lic = {
          software: document.getElementById('licSoftware').value,
          hardware: document.getElementById('licHardware').value,
          data: document.getElementById('licData').value,
          art: document.getElementById('licArt').value,
        };
        const namespace = document.getElementById('namespace').value.trim();
        const authority = document.getElementById('authority').value.trim();
        const properties = document.getElementById('properties').value.split(',').map(s=>s.trim()).filter(Boolean);
        const token = localStorage.getItem('JWT_TOKEN') || '';
        const r = await fetch('/sketch/'+ID+'/attrs', { method:'POST', headers:{'Content-Type':'application/json', ...(token?{'Authorization':'Bearer '+token}:{}) }, body: JSON.stringify({ attrs: { ...(initial||{}), licenses: lic, namespace, authority, properties } }) });
        const j = await r.json();
        if (r.ok){ alert('Saved'); document.getElementById('curMeta').textContent = JSON.stringify(j.attrs, null, 2); } else { alert(j.error||'Failed'); }
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
  </html>
